<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">

    <title>여행 지도</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        #map { width: 100%; height: 100%; margin-top: 20px; border: 1px solid #ccc; }
        .search-area { margin-bottom: 10px; }
    </style>
</head>
<body>
<header th:replace="~{layout/header}"></header>

<h2>관광지 검색 지도</h2>
<div class="search-area">
    <input type="text" id="searchKeyword" placeholder="관광지 이름을 입력하세요" />
    <button onclick="searchAttractions()">검색</button>
</div>
<div id="map"></div>

<footer th:replace="~{layout/footer}"></footer>
<!--<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a166f024ff1aa12ece8b74b52adde20d&libraries=services"></script>-->
<!--<script>-->
<!--    var container = document.getElementById('map');-->
<!--    var options = {-->
<!--        center: new kakao.maps.LatLng(33.450701, 126.570667),-->
<!--        level: 3-->
<!--    };-->

<!--    var map = new kakao.maps.Map(container, options);-->
<!--</script>-->

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a166f024ff1aa12ece8b74b52adde20d&libraries=services"></script>

<script>
    // 카카오 맵을 초기화하는 코드
    let map;

    window.onload = function() {
        // 카카오맵이 정상적으로 로드되었는지 확인
        if (typeof kakao === 'undefined') {
            alert("카카오맵 API 로딩 실패");
            return;
        }

        // 카카오 맵을 초기화하는 코드
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 중심
            level: 7
        });
    };

    // 관광지 검색 함수
    function searchAttractions() {
        const keyword = document.getElementById('searchKeyword').value.trim();
        if (!keyword) {
            alert("검색어를 입력하세요!");
            return;
        }

        fetch(`/api/attraction/search?keyword=${encodeURIComponent(keyword)}`)
            .then(response => response.text())  // 응답을 텍스트로 받아서 확인
            .then(text => {
                console.log("응답 텍스트:", text);  // 텍스트로 확인하여 오류를 분석
                try {
                    const data = JSON.parse(text);  // JSON으로 파싱 시도
                    if (!data.response?.body?.items?.item || data.response.body.items.item.length === 0) {
                        alert("검색 결과가 없습니다.");
                        return;
                    }

                    const attractions = data.response.body.items.item;
                    const bounds = new kakao.maps.LatLngBounds();

                    attractions.forEach(attraction => {
                        const position = new kakao.maps.LatLng(attraction.mapy, attraction.mapx);
                        const marker = new kakao.maps.Marker({ position });
                        marker.setMap(map);
                        bounds.extend(position);
                    });

                    map.setBounds(bounds);
                } catch (err) {
                    console.error("응답 파싱 실패:", err);
                    alert("관광지 정보를 불러오는 데 실패했습니다.");
                }
            })
            .catch(err => {
                console.error("관광지 조회 실패:", err);
                alert("관광지 정보를 불러오는 데 실패했습니다.");
            });
    }
</script>

</body>
</html>